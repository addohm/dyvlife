{% extends "base.html" %}  <!-- Assuming you have a base template -->
{% block maincontent %}
  <div class="mt-4">
    <div class="card">
      <div class="card-header brand-color-bg text-white d-flex justify-content-between align-items-center">
        <h2 class="mb-0">{{ title }}</h2>
        <a href="{% url 'customers-list' %}" class="btn btn-light btn-sm">
          <i class="bi bi-arrow-repeat"></i> Refresh
        </a>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover table-striped">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Email (Username)</th>
                <th>First Contact</th>
                <th>Interest</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for customer in customers %}
                <tr>
                  <td>{{ customer.user.get_full_name|default:customer.user.username }}</td>
                  <td>{{ customer.user.email }}</td>
                  <td>{{ customer.first_contact|date:"Y-m-d H:i" }}</td>
                  <td>{{ customer.interest }}</td>
                  <td>
                    {% if customer.paid %}
                      <span class="badge bg-success">Paid</span>
                    {% elif customer.invoiced %}
                      <span class="badge bg-warning text-dark">Invoiced</span>
                    {% else %}
                      <span class="badge bg-secondary">Pending</span>
                    {% endif %}
                  </td>
                  <td>
                    <div class="btn-group btn-group-sm" role="group">
                      <a href="{% url 'customers-update' customer.id %}"
                         class="btn btn-outline-primary"
                         title="Edit">
                        <i class="bi bi-pencil-square"></i>
                      </a>
                      <button class="btn btn-outline-info send-magic-link"
                              data-profile-id="{{ customer.id }}"
                              data-profile-name="{{ customer.user.username }}"
                              title="Send Magic Link">
                        <i class="bi bi-envelope-arrow-up"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="6" class="text-center">No customers found</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% if is_paginated %}
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
              {% if page_obj.has_previous %}
                <li class="page-item">
                  <a class="page-link" href="?page=1">« First</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.previous_page_number }}">Previous</a>
                </li>
              {% endif %}
              <li class="page-item active">
                <span class="page-link">Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>
              </li>
              {% if page_obj.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.next_page_number }}">Next</a>
                </li>
                <li class="page-item">
                  <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">Last »</a>
                </li>
              {% endif %}
            </ul>
          </nav>
        {% endif %}
      </div>
    </div>
  </div>
  <!-- Confirmation Modal -->
  <div class="modal fade"
       id="magicLinkModal"
       tabindex="-1"
       aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Send Magic Link</h5>
          <button type="button"
                  class="btn-close"
                  data-bs-dismiss="modal"
                  aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>
            Are you sure you want to send a magic login link to <strong id="profile-name"></strong>?
          </p>
          <p class="text-muted">This link will expire in 24 hours.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="confirm-send">Send Link</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Success Toast -->
  <div class="position-fixed bottom-0 end-0 p-3 magicsuccesstoast">
    <div id="successToast"
         class="toast align-items-center text-white bg-success"
         role="alert"
         aria-live="assertive"
         aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body" id="toast-message"></div>
        <button type="button"
                class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast"
                aria-label="Close"></button>
      </div>
    </div>
  </div>
{% endblock maincontent %}
{% block scripts %}
  <script>
document.addEventListener('DOMContentLoaded', function() {
    const modal = new bootstrap.Modal(document.getElementById('magicLinkModal'));
    const toast = new bootstrap.Toast(document.getElementById('successToast'));
    let currentProfileId = null;
    
    // Set up magic link buttons
    document.querySelectorAll('.send-magic-link').forEach(button => {
        button.addEventListener('click', function() {
            currentProfileId = this.dataset.profileId;
            document.getElementById('profile-name').textContent = this.dataset.profileName;
            modal.show();
        });
    });
    
    // Confirm send
    document.getElementById('confirm-send').addEventListener('click', function() {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        fetch(window.location.href, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `profile_id=${currentProfileId}`
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('toast-message').textContent = data.message;
                toast.show();
            } else {
                alert('Error: ' + data.message);
            }
            modal.hide();
        })
        .catch(error => {
            alert('Error: ' + error);
            modal.hide();
        });
    });
});
  </script>
{% endblock scripts %}
